<!DOCTYPE html>
<html lang="It">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice Assistant with Google Gemini</title>
  
  <script type="importmap">
  {
    "imports": {
      "@google/generative-ai": "https://esm.run/@google/generative-ai"
    }
  }
  </script>
  
    <script src="../static/js/script.js">
    </script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">


    
  <link id="pagestyle" href="../static/assets/css/style.css?v=1.0.7" rel="stylesheet" />

  <script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    // API_KEY
    const API_KEY = "AIzaSyACTTtwLl0wV5nu0hTcay5yko_iFw24nKs";

    // Ã¬Google Generative AI model
    const genAI = new GoogleGenerativeAI(API_KEY);
    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

    // Function to process voice input and query to Gemini
    async function queryGemini(prompt) {
      const result = await model.generateContent(prompt);
      return result.response.text();
    }

    window.addEventListener('DOMContentLoaded', () => {
     var query ='';
     var transcript;
      document.getElementById('start-btn').addEventListener('click', () => {
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'it-IT'; 
        recognition.interimResults = false;

        recognition.onresult = async (event) => {
          transcript = Array.from(event.results)
                                 .map(result => result[0].transcript)
                                 .join('');
          document.getElementById('output').textContent = `You said: ${transcript}`;

          // Query the Google Gemini with the request and the DB structure
          const response = await queryGemini("Data una struttura come quella fornita Mostrami solo il codice per fare una query per SQL management studio  per CREATE TABLE Ciclista (Codice_fiscale VARCHAR(16) PRIMARY KEY, Nome VARCHAR(50), Cognome VARCHAR(50), Eta INT, Sesso CHAR(1), Kilometri FLOAT, Posizione VARCHAR(100), On_Bike BOOLEAN, Altezza FLOAT, Peso FLOAT); CREATE TABLE Bici (ID INT PRIMARY KEY, Modello VARCHAR(50), Anno INT, Stato_ruote VARCHAR(50), Posizione VARCHAR(100), Temperatura FLOAT, Livello_di_radiazione FLOAT, Livello_di_luce FLOAT, Accelerazione FLOAT, Livello_di_umidita FLOAT, Qualita_dell_aria VARCHAR(100), In_uso BOOLEAN, Stazione INT, Online BOOLEAN, FOREIGN KEY (Stazione) REFERENCES Stazione(ID)); CREATE TABLE Corsa (Id_Corsa INT PRIMARY KEY, Id_BICI INT, Id_CICLISTA VARCHAR(16), Ora_inizio DATETIME, Ora_fine DATETIME, Feedback VARCHAR(255), FOREIGN KEY (Id_BICI) REFERENCES Bici(ID), FOREIGN KEY (Id_CICLISTA) REFERENCES Ciclista(Codice_fiscale)); CREATE TABLE Percorso (Path_ID INT PRIMARY KEY, Coord_partenza VARCHAR(100), Coord_arrivo VARCHAR(100), Codice_ciclista VARCHAR(16), Codice_corsa INT, FOREIGN KEY (Codice_ciclista) REFERENCES Ciclista(Codice_fiscale), FOREIGN KEY (Codice_corsa) REFERENCES Corsa(Id_Corsa)); CREATE TABLE Sfide (Id_sfida INT PRIMARY KEY, Codice_ciclista VARCHAR(16), Percentuale_completamento FLOAT, FOREIGN KEY (Codice_ciclista) REFERENCES Ciclista(Codice_fiscale)); CREATE TABLE Stazione (ID INT PRIMARY KEY, Indirizzo VARCHAR(100), Posti_disponibili INT); senza nient'altro e non ripetere la struttura che ti passo "+transcript);
          // Find the start and end positions of the SQL query
          const startDelimiter = '```sql';
          const endDelimiter = '```';

          const startIndex = response.indexOf(startDelimiter) + startDelimiter.length;
          const endIndex = response.indexOf(endDelimiter, startIndex);

          // Extract the query from the response.
          query = startIndex >= 0 && endIndex > startIndex
          ? response.substring(startIndex, endIndex).trim()
          : 'No query found';

          document.getElementById('gemini-result').textContent = query;
        };

        recognition.start();
      });

var results;
document.getElementById('fetchData').addEventListener('click', async () => {
  try {
    const encodedQuery = encodeURIComponent(query);

    // Construct URL to send to the request in Flask
    const url = `http://127.0.0.1:5000/fetchData?query=${encodedQuery}`;

    // Fetch data from the Flask endpoint
    const response = await fetch(url);
    const data = await response.json();

    console.table(data);

document.getElementById('fetch-result').innerHTML = `
      <pre>${JSON.stringify(data, null, 2)}</pre>
`;

    speak_return("Ecco i tuoi risultati.");

  } catch (error) {
    console.error('Error fetching data:', error);
  }
});

    });
  </script>
</head>
<body class="g-sidenav-show  bg-gray-100 virtual-reality">
  <div>
    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl" id="navbarBlur" navbar-scroll="true">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
            <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="javascript:;">Pagina</a></li>
            <li class="breadcrumb-item text-sm text-dark active" aria-current="page">Assistente virtuale</li>
          </ol>
          <h6 class="font-weight-bolder mb-0">Assistente virtuale</h6>
        </nav>
        <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
          <div class="ms-md-auto pe-md-3 d-flex align-items-center">
            <div class="input-group">
              <span class="input-group-text text-body"><i class="fas fa-search" aria-hidden="true"></i></span>
              <input type="text" class="form-control" placeholder="Cerca...">
            </div>
          </div>
          <ul class="navbar-nav  justify-content-end">
            <li class="nav-item d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-body font-weight-bold px-0">
                <i class="fa fa-user me-sm-1"></i>
                <span class="d-sm-inline d-none">Accedi</span>
              </a>
            </li>
            <li class="nav-item d-xl-none ps-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-body p-0" id="iconNavbarSidenav">
                <div class="sidenav-toggler-inner">
                  <i class="sidenav-toggler-line"></i>
                  <i class="sidenav-toggler-line"></i>
                  <i class="sidenav-toggler-line"></i>
                </div>
              </a>
            </li>
            <li class="nav-item px-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-body p-0">
                <i class="fa fa-cog fixed-plugin-button-nav cursor-pointer"></i>
              </a>
            </li>
            <li class="nav-item dropdown pe-2 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-body p-0" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fa fa-bell cursor-pointer"></i>
              </a>
              
        </div>
      </div>
    </nav>
  <div class="border-radius-xl mt-3 mx-3 position-relative" style="background-image: url('../static/assets/img/vr-bg.jpg') ; background-size: cover;">
   
    <main class="main-content mt-1 border-radius-lg">
      <div class="section min-vh-85 position-relative transform-scale-0 transform-scale-md-7">
        <div class="container">
          <div class="row pt-10">

                  <div class="card move-on-hover mt-4">
                    <div class="card-body">
                      <div class="d-flex">
                          
                          <button onclick="speak()" id="start-btn"><h3>Chiedmi pure</h3></button>

                          
                          <button id="fetchData" style="margin-left:50%;"><h3>Visualizza risultati</h3></button>

                        <div class="ms-auto">
                        </div>



                      </div>

                                <div class="row pt-10">
                  <br>
                  <div class="card move-on-hover mt-4">
                    <div class="card-body">
                      <div class="d-flex">

                          <p id="output">La tua richiesta...</p>

                        <div class="ms-auto">
                        </div>


                        
                      </div>
                      

                          <p id="gemini-result"></p>

                          <pre id="fetch-result"></pre>
  
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</body>
</html>